# 虚拟内存

```ad-summary
title:什么是虚拟内存？

虚拟内存指的是对程序可见的内存，是对物理内存的隔离，避免程序直接操纵物理内存
```

**如果程序直接操纵物理内存会有什么问题？**

多个程序可能会操纵到同一个内存区域，导致程序崩溃

**操作系统会提供一种机制，将不同进程的虚拟地址和不同内存的物理地址映射起来。**

这里就引出了两种地址的概念：

- 我们程序所使用的内存地址叫做**虚拟内存地址**（_Virtual Memory Address_）
- 实际存在硬件里面的空间地址叫**物理内存地址**（_Physical Memory Address_）

```ad-question
title:操作系统如何管理虚拟地址和物理地址之间的关系？
```

答：分段、分页、段页式

# 内存分段

# 内存分页

# 段页式

# Linux内存布局

![[Excalidraw/Linux内存分布.excalidraw.md#^group=8p1-1R5dSfu-LaFg3cDjI|750|center]]

而用户空间的虚拟内存又可以划分为不同的部分

![[Excalidraw/Linux内存分布.excalidraw.md#^group=bUCmzyD28MNdOL5hnZ80E|750|center]]

- 代码段：二进制可执行代码
- 数据段：已初始化的**静态变量**和**全局变量**
- BSS段： 未初始化的**静态变量**和**全局变量**
- 堆段：    **动态分配**的内存
- 栈段：    **局部变量**和**函数调用的上下文**，一般是8MB
- 文件映射：动态库，共享内存等

> [!question] malloc如何申请内存？
> 

malloc是一个C语言库里的函数，会通过两种方式向操作系统申请内存：

- **brk()** 系统调用从堆申请内存
- **mmap()** 系统调用从文件映射区申请内存

小内存从堆里申请，大内存从文件映射区申请，阈值一半是`128KB`

> [!question] malloc申请的是物理内存吗？
> 

答：不是

申请的是虚拟内存，只有虚拟内存被调用的时候才会通过映射关系去物理内存寻找，没有的话就发生缺页中断


> [!question] 内存满了会怎样？
> 

答：**内存回收**和**OOM**

![[Excalidraw/Linux内存分布.excalidraw.md#^group=s6OlajvSX8JWTd8HtuZRg|1000|center]]